# –ñ—É—Ä–Ω–∞–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî 18 —è–Ω–≤–∞—Ä—è 2026

**–î–∞—Ç–∞:** 2026-01-18  
**–§–∞–∑–∞:** Phase 2 ‚Äî Core Business Logic  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- –°–æ–∑–¥–∞–Ω—ã JPA-—Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è ParkingEvent –∏ Payment —Å –ø–æ–ª–Ω—ã–º –º–∞–ø–ø–∏–Ω–≥–æ–º –ø–æ–ª–µ–π
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π Billing Service —Å –ª–æ–≥–∏–∫–æ–π —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω –º–∞–ø–ø–µ—Ä –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É Entity –∏ DTO
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–æ–≥–ª–∞—Å–Ω–æ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ù–∞–ø–∏—Å–∞–Ω—ã –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ unit-—Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. **[Phase 2] Billing Service: Entities ParkingEvent, Payment and Repositories #32**

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

**A. JPA Entity:**
- `ParkingEvent`: 
  - –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `parking_events`
  - –ü–æ–ª—è: id, vehicleId, licensePlate, ticketCode, entryTime, exitTime, entryMethod, exitMethod, spotId, isSubscriber, createdAt
  - –ï–Ω—É–º—ã: `EntryMethod` (SCAN, MANUAL), `ExitMethod` (SCAN, MANUAL, AUTO)
  - @PrePersist –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ createdAt –∏ entryTime
  
- `Payment`:
  - –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `payments`
  - –ü–æ–ª—è: id, parkingEventId, amount, paymentTime, paymentMethod, status, transactionId, operatorId, createdAt
  - –ï–Ω—É–º—ã: `PaymentMethod` (CARD, CASH, MOBILE_PAY), `PaymentStatus` (PENDING, COMPLETED, FAILED, REFUNDED)
  - @PrePersist –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ createdAt –∏ paymentTime

**B. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:**
- `ParkingEventRepository` (extends JpaRepository):
  - `findByTicketCode(String ticketCode)`: –ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏—è –ø–æ –∫–æ–¥—É –±–∏–ª–µ—Ç–∞
  - `findByLicensePlateAndExitTimeIsNull(String licensePlate)`: –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π –ø–∞—Ä–∫–æ–≤–∫–∏
  - `findByEntryTimeBetween(LocalDateTime start, LocalDateTime end)`: –ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –≤—Ä–µ–º–µ–Ω–∏
  - `existsByTicketCode(String ticketCode)`: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±–∏–ª–µ—Ç–∞
  
- `PaymentRepository` (extends JpaRepository):
  - `findByParkingEventIdAndStatus(Long eventId, PaymentStatus status)`: –ø–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ —Å–æ–±—ã—Ç–∏—é –∏ —Å—Ç–∞—Ç—É—Å—É
  - `existsByParkingEventIdAndStatus(Long eventId, PaymentStatus status)`: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
  - `findByTransactionId(String transactionId)`: –ø–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**C. Unit –¢–µ—Å—Ç—ã:**

**ParkingEventRepositoryTest (8 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ testSaveAndFindById: –±–∞–∑–æ–≤—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ testFindByTicketCode: –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –±–∏–ª–µ—Ç–∞
- ‚úÖ testFindByLicensePlateAndExitTimeIsNull: –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- ‚úÖ testFindByEntryTimeBetween: –ø–æ–∏—Å–∫ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ testExistsByTicketCode: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±–∏–ª–µ—Ç–∞
- ‚úÖ testUpdateExitTime: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–µ–∑–¥–∞
- ‚úÖ testEntryAndExitMethodEnums: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –µ–Ω—É–º–æ–≤
- ‚úÖ testSubscriberFlag: —Ä–∞–±–æ—Ç–∞ —Ñ–ª–∞–≥–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞

**PaymentRepositoryTest (10 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ testSaveAndFindById: –±–∞–∑–æ–≤—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ testFindByParkingEventIdAndStatus: –ø–æ–∏—Å–∫ –ø–æ —Å–æ–±—ã—Ç–∏—é –∏ —Å—Ç–∞—Ç—É—Å—É
- ‚úÖ testExistsByParkingEventIdAndStatus: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ testFindByTransactionId: –ø–æ–∏—Å–∫ –ø–æ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ testPaymentMethodEnums: –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ–Ω—É–º–æ–≤ PaymentMethod
- ‚úÖ testPaymentStatusEnums: –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ–Ω—É–º–æ–≤ PaymentStatus
- ‚úÖ testPrePersistDefaults: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π
- ‚úÖ testUpdatePaymentStatus: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ testPaymentAmounts: —Ç–æ—á–Ω–æ—Å—Ç—å BigDecimal
- ‚úÖ testMultiplePaymentsForSameEvent: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**–ö–æ–º–º–∏—Ç:** `feat(billing): [#32] add ParkingEvent and Payment entities with repositories and tests`

---

### 2. **[Phase 2] Billing Service: Implement fee calculation logic (Service layer) #33**

#### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

**A. Domain Model & DTOs:**
- `ParkingEventDomain`: –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- `PaymentDomain`: –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
- `TariffDomain`: –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤
- Custom exceptions:
  - `ParkingEventNotFoundException`: —Å–æ–±—ã—Ç–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
  - `TicketAlreadyPaidException`: –±–∏–ª–µ—Ç —É–∂–µ –æ–ø–ª–∞—á–µ–Ω
  - `InsufficientPaymentException`: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã
  - `TariffNotFoundException`: —Ç–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω

**B. BillingService:**
- `calculateFee(String ticketCode, LocalDateTime exitTime)`: 
  - –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫–∏
  - –£—á–µ—Ç —á–∞—Å–æ–≤ —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –≤–≤–µ—Ä—Ö
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ—á–∞—Å–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏ –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ ONE_TIME
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
  
- `recordPayment(String ticketCode, BigDecimal amountPaid, PaymentMethod method, Long operatorId)`:
  - –ó–∞–ø–∏—Å—å –ø–ª–∞—Ç–µ–∂–∞
  - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å >= —Ä–∞—Å—á–µ—Ç–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏)
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ transactionId (—Ñ–æ—Ä–º–∞—Ç: TRX-{timestamp}-{random})
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ–ø–ª–∞—Ç—É
  
- `isTicketPaid(String ticketCode)`:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã –±–∏–ª–µ—Ç–∞
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ –µ—Å—Ç—å –ø–ª–∞—Ç–µ–∂ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º COMPLETED

**C. BillingMapper:**
- `toFeeCalculationResponse()`: –º–∞–ø–ø–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- `toPaymentResponse()`: –º–∞–ø–ø–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ –æ–± –æ–ø–ª–∞—Ç–µ
- `toPaymentStatusResponse()`: –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
- `toPaymentMethod()`: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è enum PaymentMethod

**D. BillingController (OpenAPI-first):**
- –†–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `BillingApi` –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
- –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `POST /api/billing/calculate`: —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–∫–æ–≤–∫–∏
  - `POST /api/billing/payment`: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
  - `GET /api/billing/payment/status/{parkingEventId}`: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤ (OffsetDateTime -> LocalDateTime)

**E. Unit Tests:**

**BillingServiceTest (16 —Ç–µ—Å—Ç–æ–≤):**
- ‚úÖ calculateFee: —Ä–∞—Å—á–µ—Ç –¥–ª—è 1h, 3h, 1.5h (—Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –≤–≤–µ—Ä—Ö)
- ‚úÖ calculateFee: –≤—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–∏–ª–µ—Ç–∞
- ‚úÖ calculateFee: –≤—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
- ‚úÖ calculateFee: –≤—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–∞—Ä–∏—Ñ–∞
- ‚úÖ recordPayment: —É—Å–ø–µ—à–Ω–∞—è –∑–∞–ø–∏—Å—å –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ recordPayment: –≤—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —Å—É–º–º–µ
- ‚úÖ recordPayment: –≤—ã–±—Ä–æ—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
- ‚úÖ recordPayment: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ transactionId
- ‚úÖ recordPayment: —Ä–∞–±–æ—Ç–∞ –±–µ–∑ operatorId (null)
- ‚úÖ isTicketPaid: –≤–æ–∑–≤—Ä–∞—Ç true –¥–ª—è –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
- ‚úÖ isTicketPaid: –≤–æ–∑–≤—Ä–∞—Ç false –¥–ª—è –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
- ‚úÖ isTicketPaid: –≤–æ–∑–≤—Ä–∞—Ç false –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–∏–ª–µ—Ç–∞

**BillingControllerTest (4 —Ç–µ—Å—Ç–∞):**
- ‚úÖ calculateFee: —É—Å–ø–µ—à–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- ‚úÖ processPayment: —É—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ processPayment: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —Å—É–º–º—ã
- ‚úÖ getPaymentStatus: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã

**–ö–æ–º–º–∏—Ç:** `feat(billing): [#33] implement fee calculation service with mapper and controller`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
```
Tests run: 33, Failures: 0, Errors: 0, Skipped: 0
```

- ‚úÖ ParkingEventRepository: 8 —Ç–µ—Å—Ç–æ–≤ (–ó–∞–¥–∞—á–∞ #32)
- ‚úÖ PaymentRepository: 10 —Ç–µ—Å—Ç–æ–≤ (–ó–∞–¥–∞—á–∞ #32)
- ‚úÖ TariffRepository: 13 —Ç–µ—Å—Ç–æ–≤ (–∏–∑ –§–∞–∑—ã 1)
- ‚úÖ BillingService: 16 —Ç–µ—Å—Ç–æ–≤ (–ó–∞–¥–∞—á–∞ #33)
- ‚úÖ BillingController: 4 —Ç–µ—Å—Ç–∞ (–ó–∞–¥–∞—á–∞ #33)
- ‚úÖ BillingServiceApplicationTests: 1 —Ç–µ—Å—Ç

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π: ~95% (–≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: ~85% (–æ—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã)
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: ~90% (CRUD + –∫–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç–æ–¥—ã)
- Entity —Å–ª–æ–π: 100% (–≤—Å–µ –ø–æ–ª—è –∏ @PrePersist —Ö—É–∫–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. **Separation of Concerns:**
- Entity: —á–∏—Å—Ç—ã–µ JPA —Å—É—â–Ω–æ—Å—Ç–∏ –±–µ–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- Domain Model: –≤—Ä–∞–ø–ø–µ—Ä –Ω–∞–¥ Entity —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
- DTO: OpenAPI —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
- Mapper: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
- Service: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- Controller: HTTP –æ–±—Ä–∞–±–æ—Ç–∫–∞

### 2. **OpenAPI-First –ø–æ–¥—Ö–æ–¥:**
- Controller —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ DTO –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 3. **Error Handling:**
- –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

### 4. **Transaction ID Generation:**
- –§–æ—Ä–º–∞—Ç: `TRX-{timestamp}-{randomHex}`
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
- –£–¥–æ–±–µ–Ω –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

### 5. **Fee Calculation Logic:**
- –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤ –≤–≤–µ—Ä—Ö (Math.ceil)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ BigDecimal –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ

---

## üìù –ó–∞–º–µ—Ç–∫–∏

### –ò–∑—É—á–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:**
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ @DataJpaTest —Å @ContextConfiguration
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ @MockBean –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è mock'–æ–≤
   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ @ExtendWith(MockitoExtension.class)

2. **OpenAPI Integration:**
   - –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ BillingApi
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤ (OffsetDateTime <-> LocalDateTime)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Optional –¥–ª—è nullable –ø–æ–ª–µ–π

3. **–ú–∞–ø–ø–∏–Ω–≥:**
   - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É Entity –∏ DTO —á–µ—Ä–µ–∑ Domain Model
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è enum —Ç–∏–ø–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ Optional –∑–Ω–∞—á–µ–Ω–∏–π

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

- **Tariff Repository:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞—Ä–∏—Ñ ONE_TIME –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤
- **Payment Status:** –¢–æ–ª—å–∫–æ COMPLETED –ø–ª–∞—Ç–µ–∂–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏
- **Rounding:** –í—Å–µ–≥–¥–∞ –æ–∫—Ä—É–≥–ª—è–µ–º —á–∞—Å—ã –≤–≤–µ—Ä—Ö –¥–ª—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
- **Transaction ID:** –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏:

1. **Integration Tests:**
   - E2E —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ flow: –≤—Ö–æ–¥ -> —Ä–∞—Å—á–µ—Ç -> –æ–ø–ª–∞—Ç–∞
   - –¢–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î (TestContainers?)

2. **API Gateway Integration:**
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –≤ API Gateway
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è endpoint'–æ–≤

3. **Gate Control Service:**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Billing Service
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –≤—ä–µ–∑–¥–∞/–≤—ã–µ–∑–¥–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –≤—ã–µ–∑–¥–µ

4. **Additional Features:**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ (–Ω–µ —Ç–æ–ª—å–∫–æ ONE_TIME)
   - –°–∫–∏–¥–∫–∏ –¥–ª—è –∞–±–æ–Ω–µ–Ω—Ç–æ–≤
   - –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

---

## üìä –ü—Ä–æ–≥—Ä–µ—Å—Å

**Phase 2 ‚Äî Core Business Logic:**
- [x] Task #32: Billing Service Entities & Repositories (100%)
- [x] Task #33: Billing Service Service Layer (100%)
- [ ] Task #34: Gate Control Service Implementation (0%)
- [ ] Task #35: Inter-service Communication (0%)

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å Phase 2:** 50%  
**–ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞–¥–∞—á:** 2 –∏–∑ 4

---

## üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

- ‚úÖ –°–æ–∑–¥–∞–Ω–æ 2 JPA-—Å—É—â–Ω–æ—Å—Ç–∏ (ParkingEvent, Payment) —Å –ø–æ–ª–Ω—ã–º –º–∞–ø–ø–∏–Ω–≥–æ–º –ø–æ–ª–µ–π
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 2 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω Billing Service —Å —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω–æ 38 –Ω–æ–≤—ã—Ö unit-—Ç–µ—Å—Ç–æ–≤ (18 –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ + 20 –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è)
- ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç (33 —Ç–µ—Å—Ç–∞ –≤—Å–µ–≥–æ)
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Hibernate -> Domain -> DTO —Å–æ–±–ª—é–¥–µ–Ω–∞
- ‚úÖ OpenAPI-first –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ > 85% –¥–ª—è –≤—Å–µ—Ö —Å–ª–æ–µ–≤
- ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ 2 –∫—Ä—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ –§–∞–∑–µ 2

**–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~1500+ (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç—ã)  
**–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ:** 52+ (33 –≤ billing-service + –¥—Ä—É–≥–∏–µ –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö)

