# üìä DATABASE MIGRATION SETUP - –ê–Ω–∞–ª–∏–∑ –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-12-25  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ê–Ω–∞–ª–∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ Database Migration –¥–ª—è –≤–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

---

## ü§î –í–ê–®–ò –í–û–ü–†–û–°–´

1. **–ß—Ç–æ —Ç–∞–∫–æ–µ Database Migration Setup?**
2. **–ü—Ä–æ –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≥–æ–≤–æ—Ä–∏—Ç—Å—è –≤ NEXT_STEPS_PHASE_0.md?**
3. **–ê–∫—Ç—É–∞–ª—å–Ω–æ –ª–∏ —ç—Ç–æ –¥–ª—è –Ω–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã?**

---

## üìö –ß–¢–û –¢–ê–ö–û–ï DATABASE MIGRATION?

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Database Migration (–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î)** - —ç—Ç–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-—Å–∫—Ä–∏–ø—Ç—ã.

### –ë–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π (–∫–∞–∫ —Å–µ–π—á–∞—Å):

```
database/init.sql  ‚Üê –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª —Å–æ –≤—Å–µ–π —Å—Ö–µ–º–æ–π
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Å—é –ë–î
- ‚ùå –°–ª–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚ùå –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –∫–æ–º–∞–Ω–¥–µ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ –ë–î
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å production –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

### –° –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ (Flyway/Liquibase):

```
database/migrations/
‚îú‚îÄ‚îÄ V1__initial_schema.sql          # –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞
‚îú‚îÄ‚îÄ V2__add_parking_lots.sql        # –î–æ–±–∞–≤–∏–ª–∏ parking_lots
‚îú‚îÄ‚îÄ V3__add_bookings.sql            # –î–æ–±–∞–≤–∏–ª–∏ bookings
‚îú‚îÄ‚îÄ V4__add_index_to_clients.sql    # –î–æ–±–∞–≤–∏–ª–∏ –∏–Ω–¥–µ–∫—Å
‚îî‚îÄ‚îÄ V5__add_column_to_users.sql     # –î–æ–±–∞–≤–∏–ª–∏ –∫–æ–ª–æ–Ω–∫—É
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ë–î
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- ‚úÖ –û—Ç–∫–∞—Ç –∫ –ª—é–±–æ–π –≤–µ—Ä—Å–∏–∏
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ production
- ‚úÖ –ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

---

## üîç –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –í–ê–®–ï–ô –ë–î

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ init.sql:

```sql
‚úÖ 1. users               # –ü–æ–ª–Ω–∞—è security implementation (38 –ø–æ–ª–µ–π!)
‚úÖ 2. user_backup_codes   # Two-factor authentication
‚úÖ 3. clients             # –ö–ª–∏–µ–Ω—Ç—ã –ø–∞—Ä–∫–æ–≤–∫–∏ (5 –ø–æ–ª–µ–π)
‚úÖ 4. vehicles            # –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (7 –ø–æ–ª–µ–π)
‚úÖ 5. subscriptions       # –ü–æ–¥–ø–∏—Å–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
‚úÖ 6. parking_events      # –°–æ–±—ã—Ç–∏—è –ø–∞—Ä–∫–æ–≤–∫–∏ (–≤—ä–µ–∑–¥/–≤—ã–µ–∑–¥)
‚úÖ 7. payments            # –ü–ª–∞—Ç–µ–∂–∏
‚úÖ 8. logs                # –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
```

**–ò—Ç–æ–≥–æ: 8 —Ç–∞–±–ª–∏—Ü —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã!**

---

## üìã –¢–ê–ë–õ–ò–¶–´ –ò–ó NEXT_STEPS (–∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢):

–í –¥–æ–∫—É–º–µ–Ω—Ç–µ NEXT_STEPS_PHASE_0.md —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è:

```sql
‚ùå 1. parking_lots        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä–∫–æ–≤–∫–∞—Ö
‚úÖ 2. parking_spaces      # –ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞ (V3)
‚úÖ 3. bookings            # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (V4)
‚ùå 4. parking_sessions    # –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–∞—Ä–∫–æ–≤–∫–∏
‚úÖ 5. tariffs             # –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã (V7 - 2026-01-16)
‚ùå 6. access_logs         # –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–æ—Ä–æ—Ç–∞–º
‚ùå 7. operators           # –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–∏—Å—Ç–µ–º—ã
```

**–ù–æ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ:**

### –ß—Ç–æ —É–∂–µ –ï–°–¢–¨ (–ø–æ–¥ –¥—Ä—É–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏):

| –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å | –ß—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|---------------|-----------------|-------------|
| ‚ùå parking_sessions | ‚úÖ parking_events | –ü–æ —Å—É—Ç–∏ —Ç–æ –∂–µ —Å–∞–º–æ–µ! |
| ‚ùå access_logs | ‚úÖ parking_events | –°–æ–±—ã—Ç–∏—è –≤—ä–µ–∑–¥–∞/–≤—ã–µ–∑–¥–∞ |
| ‚úÖ tariffs | ‚úÖ tariffs (V7) | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 2026-01-16 |
| ‚ùå operators | ‚úÖ users (role: OPERATOR) | –£–∂–µ –µ—Å—Ç—å —Ä–æ–ª—å! |

### –ß—Ç–æ –†–ï–ê–õ–¨–ù–û –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

```sql
1. parking_lots     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–∞—Ä–∫–æ–≤–∫–∞–º–∏
2. parking_spaces   # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–µ
3. bookings         # –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
```

**–¢–æ–ª—å–∫–æ 3 —Ç–∞–±–ª–∏—Ü—ã!** (–Ω–µ 8, –∫–∞–∫ –∫–∞–∑–∞–ª–æ—Å—å)

---

## üéØ –ê–ö–¢–£–ê–õ–¨–ù–û –õ–ò –≠–¢–û –î–õ–Ø –í–ê–®–ï–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–´?

### –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: **–î–ê, –Ω–æ —Å –∞–¥–∞–ø—Ç–∞—Ü–∏—è–º–∏!**

### –í–∞—à–∞ —Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  API Gateway ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ> Client Service   ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ                ‚îú‚îÄ‚îÄ> User Service      ‚îÄ‚îÄ‚î§           ‚îÇ
‚îÇ                ‚îú‚îÄ‚îÄ> Parking Service   ‚îÄ‚îÄ‚î§           ‚îÇ
‚îÇ                ‚îú‚îÄ‚îÄ> Booking Service   ‚îÄ‚îÄ‚îº‚îÄ‚îÄ> PostgreSQL
‚îÇ                ‚îú‚îÄ‚îÄ> Payment Service   ‚îÄ‚îÄ‚î§           ‚îÇ
‚îÇ                ‚îú‚îÄ‚îÄ> Billing Service   ‚îÄ‚îÄ‚î§           ‚îÇ
‚îÇ                ‚îî‚îÄ‚îÄ> Other Services    ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–µ–∫—É—â–∏–º –ø–æ–¥—Ö–æ–¥–æ–º:

**–£ –≤–∞—Å –í–°–ï —Ç–∞–±–ª–∏—Ü—ã –≤ –û–î–ù–û–ô –ë–ê–ó–ï!**

```
parking_db:
‚îú‚îÄ‚îÄ users            ‚Üê –Ω—É–∂–Ω–∞ User Service
‚îú‚îÄ‚îÄ clients          ‚Üê –Ω—É–∂–Ω–∞ Client Service
‚îú‚îÄ‚îÄ vehicles         ‚Üê –Ω—É–∂–Ω–∞ Client Service
‚îú‚îÄ‚îÄ subscriptions    ‚Üê –Ω—É–∂–Ω–∞ Billing Service
‚îú‚îÄ‚îÄ parking_events   ‚Üê –Ω—É–∂–Ω–∞ Parking Service
‚îú‚îÄ‚îÄ payments         ‚Üê –Ω—É–∂–Ω–∞ Payment Service
‚îî‚îÄ‚îÄ logs             ‚Üê –Ω—É–∂–Ω–∞ –≤—Å–µ–º
```

**–≠—Ç–æ monolithic database approach!** üò±

---

## üí° –î–í–ê –ü–û–î–•–û–î–ê –ö –†–ï–®–ï–ù–ò–Æ

### –ü–æ–¥—Ö–æ–¥ 1: Shared Database (–ø—Ä–æ—â–µ, –¥–ª—è –Ω–∞—á–∞–ª–∞) ‚úÖ

**–ß—Ç–æ —ç—Ç–æ:**
- –í—Å–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–π –ë–î
- –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û —Å–æ —Å–≤–æ–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
- –ü—Ä–æ—Å—Ç–æ–π setup, –ª–µ–≥–∫–æ –Ω–∞—á–∞—Ç—å

**–î–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**

```
parking_db (shared):
‚îú‚îÄ‚îÄ users, user_backup_codes           ‚Üê User Service
‚îú‚îÄ‚îÄ clients, vehicles                  ‚Üê Client Service  
‚îú‚îÄ‚îÄ parking_lots, parking_spaces       ‚Üê Parking Service
‚îú‚îÄ‚îÄ bookings                           ‚Üê Booking Service
‚îú‚îÄ‚îÄ subscriptions, tariffs             ‚Üê Billing Service
‚îú‚îÄ‚îÄ payments                           ‚Üê Payment Service
‚îî‚îÄ‚îÄ parking_events, access_logs        ‚Üê All services (events)
```

**‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É—é –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è:**
- –ü—Ä–æ—â–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- –ú–µ–Ω—å—à–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∞–ª—ã—Ö/—Å—Ä–µ–¥–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- –ú–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ü–æ–¥—Ö–æ–¥ 2 –ø–æ–∑–∂–µ

**Flyway/Liquibase –¥–ª—è Shared DB:**

```
database/migrations/
‚îú‚îÄ‚îÄ V1__initial_schema.sql              # –í—Å–µ —Ç–µ–∫—É—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
‚îú‚îÄ‚îÄ V2__add_parking_lots_spaces.sql     # –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è Parking Service
‚îú‚îÄ‚îÄ V3__add_bookings.sql                # –¢–∞–±–ª–∏—Ü—ã –¥–ª—è Booking Service
‚îú‚îÄ‚îÄ V4__add_tariffs.sql                 # –¢–∞—Ä–∏—Ñ—ã –¥–ª—è Billing Service (—É—Å—Ç–∞—Ä–µ–ª–æ, —Å–º. V7)
‚îú‚îÄ‚îÄ V5__performance_indexes.sql         # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ V6__extend_logs_table.sql           # –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–æ–≥–æ–≤ (service, meta)
‚îî‚îÄ‚îÄ V7__create_tariffs_table.sql        # –¢–∞—Ä–∏—Ñ—ã (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ 2026-01-16)
```

### –ü–æ–¥—Ö–æ–¥ 2: Database per Service (—Å–ª–æ–∂–Ω–µ–µ, –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ) üéì

**–ß—Ç–æ —ç—Ç–æ:**
- –ö–∞–∂–¥—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç –°–í–û–Æ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- True microservices pattern

**–î–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**

```
user_service_db:
‚îî‚îÄ‚îÄ users, user_backup_codes

client_service_db:
‚îî‚îÄ‚îÄ clients, vehicles

parking_service_db:
‚îî‚îÄ‚îÄ parking_lots, parking_spaces, parking_events

booking_service_db:
‚îî‚îÄ‚îÄ bookings

billing_service_db:
‚îî‚îÄ‚îÄ subscriptions, payments, tariffs
```

**–ö–∞–∂–¥–∞—è –ë–î –∏–º–µ–µ—Ç —Å–≤–æ–π Flyway:**

```
user-service/
‚îî‚îÄ‚îÄ src/main/resources/db/migration/
    ‚îú‚îÄ‚îÄ V1__create_users.sql
    ‚îî‚îÄ‚îÄ V2__add_2fa.sql

client-service/
‚îî‚îÄ‚îÄ src/main/resources/db/migration/
    ‚îú‚îÄ‚îÄ V1__create_clients.sql
    ‚îî‚îÄ‚îÄ V2__add_vehicles.sql
```

**–°–ª–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚ùå –ù–µ—Ç JOIN –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚ùå –ù—É–∂–Ω—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Saga pattern)
- ‚ùå –ë–æ–ª—å—à–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ë–î)
- ‚ùå –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∫–∞

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –í–ê–®–ï–ì–û –ü–†–û–ï–ö–¢–ê

### –§–∞–∑–∞ 0 (—Å–µ–π—á–∞—Å): Shared Database + Flyway

```yaml
–ß—Ç–æ –¥–µ–ª–∞—Ç—å:
1. ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π init.sql –∫–∞–∫ –µ—Å—Ç—å
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Flyway –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, API Gateway)
3. ‚úÖ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å init.sql ‚Üí V1__initial_schema.sql
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å V2, V3, V4 –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ë—ã—Å—Ç—Ä–æ –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è
- –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —É—á–µ–±–Ω–æ–≥–æ/pet-–ø—Ä–æ–µ–∫—Ç–∞
```

### –§–∞–∑–∞ 1 (–ø–æ–∑–∂–µ): –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ Database per Service

```yaml
–ö–æ–≥–¥–∞ –ø—Ä–æ–µ–∫—Ç –≤—ã—Ä–∞—Å—Ç–µ—Ç:
1. –†–∞–∑–¥–µ–ª–∏—Ç—å –ë–î –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Flyway –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏
4. –î–æ–±–∞–≤–∏—Ç—å event-driven communication (Kafka/RabbitMQ)
```

---

## üöÄ –ö–û–ù–ö–†–ï–¢–ù–´–ô –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å Flyway (30 –º–∏–Ω—É—Ç)

#### –í API Gateway (–∏–ª–∏ –ª—é–±–æ–º —Å–µ—Ä–≤–∏—Å–µ):

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

```yaml
# application.yml
spring:
  flyway:
    enabled: true
    baseline-on-migrate: true  # –í–∞–∂–Ω–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î!
    locations: classpath:db/migration
    baseline-version: 0
    baseline-description: "Existing schema"
```

### –®–∞–≥ 2: –†–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å SQL —Å–∫—Ä–∏–ø—Ç—ã (15 –º–∏–Ω—É—Ç)

```bash
# –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
database/
‚îî‚îÄ‚îÄ init.sql

# –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
backend/api-gateway/src/main/resources/db/migration/
‚îú‚îÄ‚îÄ V1__initial_schema.sql       # –∫–æ–ø–∏—è init.sql
‚îú‚îÄ‚îÄ V2__add_parking_lots.sql     # –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îú‚îÄ‚îÄ V3__add_parking_spaces.sql   # –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îî‚îÄ‚îÄ V4__add_bookings.sql         # –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã (1-2 —á–∞—Å–∞)

#### V2__add_parking_lots.sql:
```sql
-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä–∫–æ–≤–∫–∞—Ö
CREATE TABLE parking_lots (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address VARCHAR(500),
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    total_spaces INTEGER NOT NULL DEFAULT 0,
    available_spaces INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_parking_lots_name ON parking_lots(name);
```

#### V3__add_parking_spaces.sql:
```sql
-- –ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞
CREATE TABLE parking_spaces (
    id BIGSERIAL PRIMARY KEY,
    parking_lot_id BIGINT NOT NULL REFERENCES parking_lots(id),
    space_number VARCHAR(20) NOT NULL,
    space_type VARCHAR(50) DEFAULT 'STANDARD', 
    -- STANDARD, HANDICAPPED, ELECTRIC, VIP
    status VARCHAR(20) DEFAULT 'AVAILABLE',
    -- AVAILABLE, OCCUPIED, RESERVED, MAINTENANCE, OUT_OF_SERVICE
    floor_level INTEGER,
    section VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(parking_lot_id, space_number)
);

CREATE INDEX idx_parking_spaces_status ON parking_spaces(status);
CREATE INDEX idx_parking_spaces_lot ON parking_spaces(parking_lot_id);
```

#### V4__add_bookings.sql:
```sql
-- –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
CREATE TABLE bookings (
    id BIGSERIAL PRIMARY KEY,
    client_id BIGINT NOT NULL REFERENCES clients(id),
    parking_space_id BIGINT NOT NULL REFERENCES parking_spaces(id),
    vehicle_id BIGINT REFERENCES vehicles(id),
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    -- PENDING, CONFIRMED, ACTIVE, COMPLETED, CANCELLED, NO_SHOW
    booking_code VARCHAR(20) UNIQUE,
    total_cost DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP,
    cancellation_reason TEXT
);

CREATE INDEX idx_bookings_client ON bookings(client_id);
CREATE INDEX idx_bookings_space ON bookings(parking_space_id);
CREATE INDEX idx_bookings_time ON bookings(start_time, end_time);
CREATE INDEX idx_bookings_status ON bookings(status);
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω—É—Ç)

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down -v

# 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã —Å Flyway
mvn clean package

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Flyway
docker logs api-gateway | grep Flyway

# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# Flyway baseline: 0 (Existing schema)
# Flyway migration: V1__initial_schema.sql
# Flyway migration: V2__add_parking_lots.sql
# ...
```

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï: –î–û –∏ –ü–û–°–õ–ï

### –î–æ (—Å–µ–π—á–∞—Å):

```
‚úÖ –ï—Å—Ç—å:
- 8 —Ç–∞–±–ª–∏—Ü –≤ database/init.sql
- –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

‚ùå –ü—Ä–æ–±–ª–µ–º—ã:
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –ë–î = —Ä—É—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°–ª–æ–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
```

### –ü–æ—Å–ª–µ (—Å Flyway):

```
‚úÖ –ü–æ–ª—É—á–∏–º:
- 11 —Ç–∞–±–ª–∏—Ü (8 —Å—Ç–∞—Ä—ã—Ö + 3 –Ω–æ–≤—ã—Ö)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è production

‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥!
```

---

## üéØ –ò–¢–û–ì–û–í–´–ô –û–¢–í–ï–¢ –ù–ê –í–ê–®–ò –í–û–ü–†–û–°–´

### 1. –ß—Ç–æ —Ç–∞–∫–æ–µ Database Migration Setup?

**–û—Ç–≤–µ—Ç:** –≠—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å—Ö–µ–º—ã –ë–î —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-—Å–∫—Ä–∏–ø—Ç—ã (V1, V2, V3...). –í–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ –±–æ–ª—å—à–æ–≥–æ init.sql, –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª.

### 2. –ü—Ä–æ –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≥–æ–≤–æ—Ä–∏—Ç—Å—è?

**–û—Ç–≤–µ—Ç:** –í –¥–æ–∫—É–º–µ–Ω—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è 8 —Ç–∞–±–ª–∏—Ü:
- 5 –∏–∑ –Ω–∏—Ö **–£–ñ–ï –ï–°–¢–¨** (–ø–æ–¥ –¥—Ä—É–≥–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏)
- 3 **–†–ï–ê–õ–¨–ù–û –ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨**:
  - parking_lots (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∫–∞–º–∏)
  - parking_spaces (–ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞)
  - bookings (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

### 3. –ê–∫—Ç—É–∞–ª—å–Ω–æ –ª–∏ —ç—Ç–æ –¥–ª—è –Ω–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã?

**–û—Ç–≤–µ—Ç: –î–ê, –û–ß–ï–ù–¨ –ê–ö–¢–£–ê–õ–¨–ù–û!**

**–ü–æ—á–µ–º—É:**
- ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ë–î
- ‚úÖ –ù–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è production
- ‚úÖ –£–ø—Ä–æ—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –æ—Ç–∫–∞—Ç—ã
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –¥–ª—è microservices

**–ö–∞–∫ –≤–Ω–µ–¥—Ä–∏—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å Flyway dependency (5 –º–∏–Ω—É—Ç)
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Flyway –≤ application.yml (5 –º–∏–Ω—É—Ç)
3. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å init.sql ‚Üí V1__initial_schema.sql (5 –º–∏–Ω—É—Ç)
4. –°–æ–∑–¥–∞—Ç—å V2, V3, V4 –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü (1-2 —á–∞—Å–∞)
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å (30 –º–∏–Ω—É—Ç)

**–û–±—â–µ–µ –≤—Ä–µ–º—è: 2-3 —á–∞—Å–∞**

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–î–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ:**

```yaml
–ü–æ–¥—Ö–æ–¥: Shared Database + Flyway

–ü–æ—á–µ–º—É:
- –ü—Ä–æ—Å—Ç–æ–π –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è pet/—É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞  
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –î–∞—ë—Ç –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ version control –¥–ª—è –ë–î
- –ú–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Database-per-Service –ø–æ–∑–∂–µ

–í—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è: 2-3 —á–∞—Å–∞
–°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è
–ü–æ–ª—å–∑–∞: –í—ã—Å–æ–∫–∞—è ‚úÖ
```

---

**TL;DR:** 
Database Migration Setup - —ç—Ç–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ë–î. –î–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ –∏ –Ω—É–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å. –í–º–µ—Å—Ç–æ 8 –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ 3 (parking_lots, parking_spaces, bookings). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Shared Database + Flyway. –í—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è: 2-3 —á–∞—Å–∞.

üéØ **–ì–æ—Ç–æ–≤—ã –≤–Ω–µ–¥—Ä—è—Ç—å? –ú–æ–≥—É –ø–æ–º–æ—á—å —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —à–∞–≥–∞–º–∏!**

