# ‚úÖ CORS Error Fixed - 2026-01-13

## Problem

```
Access to fetch at 'http://localhost:8086/api/clients//vehicles' from origin 'null' 
has been blocked by CORS policy: Response to preflight request doesn't pass access 
control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.

GET http://localhost:8086/api/clients//vehicles net::ERR_FAILED
```

**Two issues identified:**
1. **CORS Error** - API Gateway not allowing `origin: null` (file:// protocol)
2. **Double slash** in URL - `/api/clients//vehicles` (empty clientId)

---

## Root Causes

### 1. CORS Configuration

**Problem:** Spring Security CORS configuration didn't explicitly allow `origin: null`.

When opening HTML files directly (file:// protocol), browser sends `Origin: null` header. 
The existing CORS config with `allowedOriginPatterns("*")` and `allowCredentials(true)` 
doesn't work with null origin.

### 2. Double Slash in URL

**Problem:** test-login.html button concatenated empty clientId:

```javascript
// Before (BROKEN):
onclick="testEndpoint('GET', '/api/clients/' + document.getElementById('clientIdForVehicles').value + '/vehicles')"
// If clientIdForVehicles is empty ‚Üí /api/clients//vehicles
```

---

## Solutions Applied

### 1. ‚úÖ Fixed CORS Configuration

**File:** `backend/api-gateway/src/main/java/com/parking/api_gateway/security/config/SecurityConfiguration.java`

**Before:**
```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    
    configuration.setAllowedOriginPatterns(List.of("*"));
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"));
    configuration.setAllowedHeaders(List.of("*"));
    configuration.setExposedHeaders(Arrays.asList("Authorization", "Content-Type"));
    configuration.setAllowCredentials(true);
    configuration.setMaxAge(3600L);
    
    // ...
}
```

**After:**
```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    
    // Allow null origin for file:// protocol testing (local HTML files)
    configuration.setAllowedOriginPatterns(List.of("*"));
    configuration.setAllowedOrigins(List.of("null")); // ‚Üê ADDED THIS
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"));
    configuration.setAllowedHeaders(List.of("*"));
    configuration.setExposedHeaders(Arrays.asList("Authorization", "Content-Type"));
    configuration.setAllowCredentials(true);
    configuration.setMaxAge(3600L);
    
    // ...
}
```

**Key Change:** Added `configuration.setAllowedOrigins(List.of("null"))`

### 2. ‚úÖ Fixed Double Slash Issue

**File:** `devops/test-login.html`

**Before:**
```html
<div class="form-group">
    <label for="clientIdForVehicles">Client ID:</label>
    <input type="number" id="clientIdForVehicles" placeholder="e.g., 1">
</div>
<button onclick="testEndpoint('GET', '/api/clients/' + document.getElementById('clientIdForVehicles').value + '/vehicles')">
    <span class="method-badge method-get">GET</span> Get Client's Vehicles
</button>
```

**After:**
```html
<div class="form-group">
    <label for="clientIdForVehicles">Client ID:</label>
    <input type="number" id="clientIdForVehicles" placeholder="e.g., 1" value="1">
</div>
<button onclick="(() => {
    const clientId = document.getElementById('clientIdForVehicles').value;
    if (!clientId) { alert('Please enter Client ID'); return; }
    testEndpoint('GET', `/api/clients/${clientId}/vehicles`);
})()">
    <span class="method-badge method-get">GET</span> Get Client's Vehicles
</button>
```

**Key Changes:**
1. Added `value="1"` as default
2. Wrapped in IIFE to validate clientId
3. Shows alert if clientId is empty
4. Uses template literals for cleaner URL building

---

## Files Modified

1. ‚úÖ `backend/api-gateway/src/main/java/com/parking/api_gateway/security/config/SecurityConfiguration.java`
   - Added explicit null origin support

2. ‚úÖ `devops/test-login.html`
   - Fixed double slash issue with validation
   - Added default value to input field

---

## Testing

### Rebuild and Restart

```powershell
# Rebuild api-gateway
cd backend/api-gateway
mvn clean package -DskipTests

# Restart container
cd ../..
docker-compose up -d --build api-gateway
```

### Test CORS

1. Open `devops/test-login.html` directly in browser (file:// protocol)
2. Login as admin
3. Try any API endpoint

**Expected:** No CORS errors, requests work normally

### Test Get Client's Vehicles

1. Open "üë• Clients" tab
2. Scroll to "Get Client's Vehicles"
3. Enter Client ID: 1
4. Click "GET Get Client's Vehicles"

**Expected:** 
- URL: `http://localhost:8086/api/clients/1/vehicles` (no double slash)
- Response: 200 OK with vehicles array

**If empty Client ID:**
- Alert: "Please enter Client ID"
- No request sent

---

## Why This Works

### CORS with null origin

**Spring Security CORS behavior:**
- `allowedOriginPatterns("*")` - Matches patterns like `http://localhost:*`
- `allowedOrigins("null")` - Explicitly allows the literal string "null"

**Browser behavior with file:// protocol:**
- Browser sends `Origin: null` header
- Without explicit allowance, server rejects preflight OPTIONS request
- With `allowedOrigins("null")`, server responds with `Access-Control-Allow-Origin: null`

### Why allowCredentials + null is OK

**Security consideration:**
- `allowCredentials(true)` + `allowedOrigins("*")` = ‚ùå FORBIDDEN (security risk)
- `allowCredentials(true)` + `allowedOrigins("null")` = ‚úÖ OK (specific origin)

**Use case:**
- Development/testing with local HTML files (file:// protocol)
- Production should use proper domain origins

---

## Production Recommendations

### For Production Deployment

**Update CORS config to remove null origin:**

```java
@Bean
public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    
    // Production: Only allow specific domains
    configuration.setAllowedOrigins(Arrays.asList(
        "https://yourdomain.com",
        "https://www.yourdomain.com"
    ));
    // Remove: configuration.setAllowedOrigins(List.of("null"));
    
    configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"));
    configuration.setAllowedHeaders(List.of("*"));
    configuration.setExposedHeaders(Arrays.asList("Authorization", "Content-Type"));
    configuration.setAllowCredentials(true);
    configuration.setMaxAge(3600L);
    
    // ...
}
```

### Environment-based Configuration

**application.yml:**
```yaml
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:null}  # Default: allow null for development
```

**docker-compose.yml (production):**
```yaml
api-gateway:
  environment:
    CORS_ALLOWED_ORIGINS: "https://yourdomain.com,https://www.yourdomain.com"
```

---

## Common CORS Issues

### Issue 1: No 'Access-Control-Allow-Origin' header

**Cause:** Server not configured for CORS  
**Solution:** Add CORS configuration to Spring Security

### Issue 2: Origin 'null' blocked

**Cause:** Server doesn't explicitly allow null origin  
**Solution:** Add `allowedOrigins("null")` for file:// protocol

### Issue 3: Credentials + wildcard

**Cause:** `allowCredentials(true)` + `allowedOrigins("*")`  
**Solution:** Use specific origins or patterns, not wildcard

### Issue 4: Preflight request fails

**Cause:** OPTIONS method not allowed  
**Solution:** Add "OPTIONS" to `allowedMethods`

---

## Summary

### Problems:
1. CORS blocked requests from `origin: null` (file:// protocol)
2. Double slash in URL due to empty clientId

### Solutions:
1. Added explicit `allowedOrigins("null")` to CORS config
2. Added validation and default value to clientId input

### Result:
- ‚úÖ CORS errors eliminated
- ‚úÖ URL building fixed
- ‚úÖ test-login.html works with file:// protocol
- ‚úÖ All API endpoints accessible from local HTML file

---

**Date:** 2026-01-13  
**Issue:** CORS policy blocking requests from null origin  
**Fix:** Added null origin support + fixed double slash  
**Status:** ‚úÖ RESOLVED

