# NOTE:
# This file (`check-api-gateway-health.ps1~`) is an editor backup and should not be used or version-controlled.
# The canonical script is `check-api-gateway-health.ps1` (without the trailing `~`).
# Please remove this file from version control (e.g., via `git rm devops/check-api-gateway-health.ps1~`).
# 4. Authentication Works
Write-Host "[4/6] Authentication Endpoint..." -ForegroundColor Yellow
$checks++
$loginBody = '{"username":"admin","password":"parking123"}'
try {
    $loginResponse = Invoke-WebRequest -Uri "http://localhost:8086/api/auth/login" `
        -Method POST `
        -ContentType "application/json" `
        -Body $loginBody `
        -UseBasicParsing `
        -TimeoutSec 5 `
        -ErrorAction Stop

    Write-Host "  [OK] Login endpoint works" -ForegroundColor Green
    $token = ($loginResponse.Content | ConvertFrom-Json).accessToken
    if ($token) {
        Write-Host "  Token: $($token.Substring(0,30))..." -ForegroundColor Gray
    } else {
        Write-Host "  Token: received but empty" -ForegroundColor Yellow
    }
} catch {
    Write-Host "  [ERROR] Login endpoint FAILED!" -ForegroundColor Red
    Write-Host "  Error: $($_.Exception.Message)" -ForegroundColor Gray
    $issues++
    $token = $null
}
Write-Host ""

# 5. Proxy Logs Visible
Write-Host "[5/6] Checking for Proxy Logs..." -ForegroundColor Yellow
$checks++
$recentLogs = docker logs api-gateway --tail 50 --since 5m 2>&1 | Out-String
if ($recentLogs -match "ClientProxy|Proxying") {
    Write-Host "  [OK] Proxy activity visible in logs" -ForegroundColor Green
    $proxyLines = $recentLogs -split "`n" | Select-String "ClientProxy|Proxying" | Select-Object -Last 3
    $proxyLines | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
} else {
    Write-Host "  WARNING: No proxy activity in recent logs" -ForegroundColor Yellow
    Write-Host "  (This might be OK if no requests were made)" -ForegroundColor Gray
}
Write-Host ""

# 6. Proxy Functionality
if ($token) {
    Write-Host "[6/6] Testing Proxy to Client Service..." -ForegroundColor Yellow
    $checks++
    try {
        $headers = @{ "Authorization" = "Bearer $token" }
        $proxyResponse = Invoke-WebRequest -Uri "http://localhost:8086/api/clients" `
            -Method GET `
            -Headers $headers `
            -UseBasicParsing `
            -TimeoutSec 5 `
            -ErrorAction Stop

        Write-Host "  [OK] Proxy works! Status: $($proxyResponse.StatusCode)" -ForegroundColor Green
        Write-Host "  Response length: $($proxyResponse.Content.Length) bytes" -ForegroundColor Gray
    } catch {
        Write-Host "  [ERROR] Proxy FAILED!" -ForegroundColor Red
        Write-Host "  Status: $($_.Exception.Response.StatusCode.value__)" -ForegroundColor Gray
        $issues++
    }
} else {
    Write-Host "[6/6] Skipping proxy test (no token)" -ForegroundColor Gray
}
Write-Host ""

# Summary
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "           SUMMARY" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Checks performed: $checks" -ForegroundColor White
Write-Host "Issues found: $issues" -ForegroundColor $(if ($issues -eq 0) { "Green" } else { "Red" })
Write-Host ""

if ($issues -eq 0) {
    Write-Host "[OK] ALL CHECKS PASSED!" -ForegroundColor Green
    Write-Host ""
    Write-Host "API Gateway is healthy and working correctly." -ForegroundColor White
} else {
    Write-Host "[WARNING] ISSUES DETECTED!" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "Recommended actions:" -ForegroundColor White
    Write-Host "  1. Check logs: docker logs api-gateway --tail 100" -ForegroundColor Gray
    Write-Host "  2. Restart: docker-compose restart api-gateway" -ForegroundColor Gray
    Write-Host "  3. Rebuild: docker-compose build --no-cache api-gateway" -ForegroundColor Gray
    Write-Host "  4. Check Eureka: http://localhost:8761" -ForegroundColor Gray
}
Write-Host ""

